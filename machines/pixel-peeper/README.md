# Machine Configuration Structure

This directory contains the NixOS system configuration for the pixel-peeper machine, organized into modular components for better maintainability and clarity.

## Structure Overview

```
pixel-peeper/
‚îú‚îÄ‚îÄ default.nix              # Main configuration file that imports all modules
‚îú‚îÄ‚îÄ hardware-configuration.nix  # Auto-generated hardware configuration
‚îú‚îÄ‚îÄ boot.nix                 # Bootloader and boot configuration
‚îú‚îÄ‚îÄ system.nix               # Core system settings (hostname, packages, etc.)
‚îú‚îÄ‚îÄ locale.nix               # Locale, timezone, and internationalization
‚îú‚îÄ‚îÄ users.nix                # User accounts and shell configuration
‚îú‚îÄ‚îÄ programs.nix             # System programs and applications
‚îú‚îÄ‚îÄ graphics.nix             # Graphics drivers and VA-API configuration
‚îú‚îÄ‚îÄ audio.nix                # Audio system (Pipewire) configuration
‚îú‚îÄ‚îÄ bluetooth.nix            # Bluetooth hardware and services
‚îú‚îÄ‚îÄ x11.nix                  # X11 compatibility layer
‚îú‚îÄ‚îÄ wayland.nix              # Wayland compositor (Hyprland) configuration
‚îú‚îÄ‚îÄ security.nix             # Security, PAM, and D-Bus configuration
‚îî‚îÄ‚îÄ maint.nix                # System maintenance (auto-update, GC, optimization)
```

## Module Descriptions

### `default.nix`
The entry point that imports all configuration modules. This is the file imported by `flake.nix`.

### `hardware-configuration.nix`
Auto-generated by `nixos-generate-config`. Contains hardware-specific settings like:
- Disk partitions and filesystems
- Kernel modules
- CPU microcode
- **Do not manually modify this file** - regenerate when hardware changes

### `boot.nix`
Bootloader configuration:
- systemd-boot settings
- EFI configuration
- Boot generation limits

### `system.nix`
Core system settings:
- Hostname
- NixOS settings (experimental features, buffer sizes)
- Basic services (NetworkManager, OpenSSH)
- Package policy (allow unfree)
- State version

### `locale.nix`
Internationalization settings:
- Timezone
- Default locale
- LC_* environment variables

### `users.nix`
User account configuration:
- Default shell (zsh)
- User accounts and groups
- Shell installation

### `programs.nix`
System programs:
- Essential system packages
- Firefox
- Network manager applet

### `graphics.nix`
Graphics drivers and hardware acceleration:
- Intel Media Driver
- VA-API support
- Vulkan drivers

### `audio.nix`
Audio system configuration:
- Pipewire (replaces PulseAudio)
- ALSA support
- 32-bit compatibility
- RTKit for real-time scheduling

### `bluetooth.nix`
Bluetooth functionality:
- Hardware enablement
- Blueman service

### `x11.nix`
X11 compatibility layer:
- X server for legacy applications
- Keyboard layout configuration

### `wayland.nix`
Modern Wayland compositor:
- Hyprland window manager
- XDG desktop portals
- Ozone for Chromium-based browsers

### `security.nix`
Security and system services:
- PAM configuration for hyprlock
- D-Bus service
- Dconf settings

### `maint.nix`
System maintenance automation:
- Automatic system upgrades
- Nix garbage collection
- Store optimization

## Adding New Configuration

To add new configuration:

1. **Determine the appropriate module** based on the setting type
2. **Add the configuration** to the corresponding `.nix` file
3. **If creating a new category**, create a new module file and add it to `default.nix` imports

### Example: Adding a New Service

To add the OpenSSH service (already in `system.nix`):

```nix
# In system.nix
services.openssh.enable = true;
```

### Example: Creating a New Module

If you need a new category (e.g., `virtualization.nix`):

1. Create `machines/pixel-peeper/virtualization.nix`:
```nix
{ config, pkgs, ... }:
{
  # Virtualization settings
  virtualisation.docker.enable = true;
}
```

2. Add to `default.nix` imports:
```nix
imports = [
  # ... other imports
  ./virtualization.nix
];
```

## Benefits of This Structure

1. **Separation of Concerns**: Each module handles a specific system aspect
2. **Easier Navigation**: Find settings by category, not by searching a large file
3. **Better Maintainability**: Modify one area without affecting others
4. **Cleaner History**: Git diffs show exactly what changed
5. **Reusability**: Share modules between machines if needed

## Hardware-Specific Notes

- **LUKS Encryption**: Disk encryption configuration is in `hardware-configuration.nix` (auto-generated)
- **Intel Graphics**: This machine uses Intel integrated graphics with VA-API drivers
- **CPU**: Intel with microcode updates enabled

## Troubleshooting

If the system fails to build:

1. Check which module is causing the issue:
   ```bash
   nix flake check --show-trace
   ```

2. Validate individual modules:
   ```bash
   nix-instantiate --eval ./default.nix
   ```

3. Check for syntax errors in the problematic module


## üìù Last Updated

- Date: 2025-10-31
- Changes:
  - Updated `system.nix`