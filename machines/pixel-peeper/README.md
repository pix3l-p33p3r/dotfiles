# Machine Configuration Structure

This directory contains the NixOS system configuration for the pixel-peeper machine, organized into modular components for better maintainability and clarity.

## Structure Overview

```
pixel-peeper/
â”œâ”€â”€ default.nix              # Main configuration file that imports all modules
â”œâ”€â”€ hardware-configuration.nix  # Auto-generated hardware configuration
â”œâ”€â”€ boot.nix                 # Bootloader and boot configuration
â”œâ”€â”€ system.nix               # Core system settings (hostname, packages, etc.)
â”œâ”€â”€ locale.nix               # Locale, timezone, and internationalization
â”œâ”€â”€ users.nix                # User accounts and shell configuration
â”œâ”€â”€ programs.nix             # System programs and applications
â”œâ”€â”€ graphics.nix             # Graphics drivers and VA-API configuration
â”œâ”€â”€ audio.nix                # Audio system (Pipewire) configuration
â”œâ”€â”€ bluetooth.nix            # Bluetooth hardware and services
â”œâ”€â”€ x11.nix                  # X11 compatibility layer
â”œâ”€â”€ wayland.nix              # Wayland compositor (Hyprland) configuration
â”œâ”€â”€ security.nix             # Security, PAM, and D-Bus configuration
â””â”€â”€ maint.nix                # System maintenance (auto-update, GC, optimization)
```

## Module Descriptions

### `default.nix`
The entry point that imports all configuration modules. This is the file imported by `flake.nix`.

### `hardware-configuration.nix`
Auto-generated by `nixos-generate-config`. Contains hardware-specific settings like:
- Disk partitions and filesystems
- Kernel modules
- CPU microcode
- **Do not manually modify this file** - regenerate when hardware changes

### `boot.nix`
Bootloader configuration:
- systemd-boot settings
- EFI configuration
- Boot generation limits

### `system.nix`
Core system settings:
- Hostname
- NixOS settings (experimental features, buffer sizes)
- Basic services (NetworkManager, OpenSSH)
- Package policy (allow unfree)
- State version

### `locale.nix`
Internationalization settings:
- Timezone
- Default locale
- LC_* environment variables

### `users.nix`
User account configuration:
- Default shell (zsh)
- User accounts and groups
- Shell installation

### `programs.nix`
System programs:
- Essential system packages
- Firefox
- Network manager applet

### `graphics.nix`
Graphics drivers and hardware acceleration:
- Intel Media Driver
- VA-API support
- Vulkan drivers

### `audio.nix`
Audio system configuration:
- Pipewire (replaces PulseAudio)
- ALSA support
- 32-bit compatibility
- RTKit for real-time scheduling

### `bluetooth.nix`
Bluetooth functionality:
- Hardware enablement
- Blueman service

### `x11.nix`
X11 compatibility layer:
- X server for legacy applications
- Keyboard layout configuration

### `wayland.nix`
Modern Wayland compositor:
- Hyprland window manager
- XDG desktop portals
- Ozone for Chromium-based browsers

### `security.nix`
Security and system services:
- PAM configuration for hyprlock
- D-Bus service
- Dconf settings

### `maint.nix`
System maintenance automation:
- Automatic system upgrades
- Nix garbage collection
- Store optimization

## Adding New Configuration

To add new configuration:

1. **Determine the appropriate module** based on the setting type
2. **Add the configuration** to the corresponding `.nix` file
3. **If creating a new category**, create a new module file and add it to `default.nix` imports

### Example: Adding a New Service

To add the OpenSSH service (already in `system.nix`):

```nix
# In system.nix
services.openssh.enable = true;
```

### Example: Creating a New Module

If you need a new category (e.g., `virtualization.nix`):

1. Create `machines/pixel-peeper/virtualization.nix`:
```nix
{ config, pkgs, ... }:
{
  # Virtualization settings
  virtualisation.docker.enable = true;
}
```

2. Add to `default.nix` imports:
```nix
imports = [
  # ... other imports
  ./virtualization.nix
];
```

## Benefits of This Structure

1. **Separation of Concerns**: Each module handles a specific system aspect
2. **Easier Navigation**: Find settings by category, not by searching a large file
3. **Better Maintainability**: Modify one area without affecting others
4. **Cleaner History**: Git diffs show exactly what changed
5. **Reusability**: Share modules between machines if needed

## Hardware-Specific Notes

- **LUKS Encryption**: Disk encryption configuration is in `hardware-configuration.nix` (auto-generated)
- **Intel Graphics**: This machine uses Intel integrated graphics with VA-API drivers
- **CPU**: Intel with microcode updates enabled

## Troubleshooting

If the system fails to build:

1. Check which module is causing the issue:
   ```bash
   nix flake check --show-trace
   ```

2. Validate individual modules:
   ```bash
   nix-instantiate --eval ./default.nix
   ```

3. Check for syntax errors in the problematic module


## ðŸ§© Services Matrix

A quick map of enabled services/programs and where they are configured.

| Service/Program | Type | Module | Notes |
|---|---|---|---|
| NetworkManager | system service | `system.nix` (`networking.networkmanager.enable`) | Primary networking |
| UPower | system service | `system.nix` (`services.upower.enable`) | Power metrics for hyprpanel |
| power-profiles-daemon | system service | `system.nix` (`services.power-profiles-daemon.enable`) | Power mode switching |
| OpenSSH | system service | `system.nix` (`services.openssh.enable`) | SSH server |
| Printing (CUPS) | system service | `system.nix` (`services.printing.enable`) | Printer support |
| D-Bus | system service | `security.nix` (`services.dbus.enable`) | IPC bus |
| X11 | system service | `x11.nix` (`services.xserver.enable`) | XWayland/legacy apps |
| Bluetooth (Blueman) | system service | `bluetooth.nix` (`services.blueman.enable`) | Bluetooth manager |
| Blueman Applet | user service | `configs/desktop/hyprland/core/services-config.nix` | Tray applet |
| Network Manager Applet | program | `machines/pixel-peeper/programs.nix` (`programs.nm-applet.enable`) | Tray indicator |
| poweralertd | user service | `configs/desktop/hyprland/core/services-config.nix` | Power alerts |
| mpdris2 | user service | `configs/desktop/hyprland/core/services-config.nix` | MPRIS for MPD |
| Hyprland | program | `machines/pixel-peeper/wayland.nix` (`programs.hyprland.enable`) | Wayland compositor |

Note: Additional Hyprland applets (hypridle, hyprlock, hyprpaper, hyprpanel) are configured under `configs/desktop/hyprland/apps/applets/` with user services as needed.